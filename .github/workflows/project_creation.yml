name: Initialise Repo
on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  run-script:
    name: run script

    # We will only run this action when this repository isn't the
    # template repository
    #
    if: >-
      ${{ !github.event.repository.is_template }}

    runs-on: ubuntu-latest

    steps:
      - name: Configure Git
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR_EMAIL}"
        shell: bash

      - name: Checkout
        uses: actions/checkout@v3

      - name: Run script
        run: |
          # This needs to have a project scope token for authentification?
          ### authentication stuff here?? ###
          
          # get the name of the current repository and store in variable REPONAME
          REPONAME=`gh repo view --json name -q ".name"`

          # Need to create a new project. Use the same name as the repo.
          # can use gh project create but trying copy as a way to use the kanban template
          echo "Creating a project based on the Kanban template"
          gh project copy 34 --source-owner NewcastleRSE --target-owner NewcastleRSE --title $REPONAME
          # NB!! Should the owner here be the current user (@me is the shorthand for getting current user) 
          # or should it be the NewcastleRSE team?

          # Need to link the project to this repo:
          echo "Link the project to the new repo"
          gh project link -R $REPONAME


      # TODO: delete this workflow file

      - name: Add files and commit changes
        run: |
          git add .
          git commit -m "Automated changes"
          git push -u origin master
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
